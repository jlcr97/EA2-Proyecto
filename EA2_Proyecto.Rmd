---
title: "EA2_Proyecto"
output: html_document
---

```{r}
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
#install.packages("olsrr"), es para las regresiones
library(olsrr)
#install.packates("GGally"), extensión de ggplot
#install.packages("GGally")
library(GGally)
```

Lectura de la base de datos
```{r}
  datos <- read.csv("BaseDatosEA2.csv")
```

Número de renglones y nombre de las columnas 
```{r}
  nrow(datos) 
  names(datos)
```

Seleccionamos las columnas que queremos trabajar y filtrando Avaro Obregon para nuestro análisis
```{r}

 datos <- datos %>% 
  select(sexo_jefe,edad_jefe,educa_jefe,tot_integ,perc_ocupa, ubica_geo, est_socio, ing_cor,gasto_mon,otros_gas,ahorro,deposito,retiro_inv,pago_tarje, tabaco, erogac_tot, 
         deudas, vestido, transporte) %>% 
  filter(ubica_geo > 9009, ubica_geo < 9011) ##Alvaro Obregon es el 9010
#Otras erogaciones: suma de depositos, pago de deudas, tarjetas de crédito, préstamos a otros
nrow(datos)
#Creamos una nueva columna para la edad al cuadrado
datos = mutate(datos, edad_2=datos$edad_jefe^2)
  head(datos)
```

Optimizar la elección de variables para nuestro modelo de regresión lineal múltiple.

Buscamos estimar al ingreso de las viviendas en ALvaro Obregon, ya no al ahorro por la manera en la que la definimos Ahorro = Ingresos - Gastos, si ocupamos cualquier otra variable que no sea ingreso y gasto obtenemos una R^2 máxima del 20%

```{r}
#Esta era el modelo que teníamos del ahorro
#modeloAhorro <- lm(datos$ahorro ~ ing_cor + sexo_jefe + educa_jefe + tot_integ + perc_ocupa + tabaco + erogac_tot, data = datos)
#ols_step_best_subset(modeloAhorro)

#Otras erogaciones: suma de depositos, pago de deudas, tarjetas de crédito, préstamos a otros

#Regresión múltiple lineal entre todas las combinaciones posibles de 8 variables
modeloCDMX <- lm(datos$ing_cor ~ est_socio + edad_2 + perc_ocupa + erogac_tot + gasto_mon + sexo_jefe + educa_jefe + tot_integ + edad_jefe, data = datos)

#Optimiza y muestra las mejores 8 regresiones por número de variables a tomar en cuenta
ols_step_best_subset(modeloCDMX)

#Tomamos la primera que alcanza una R^2 de 0.7 con 5 variables
# Ingreso = edad_2 + perc_ocupa + erogac_tot + gasto_mon + educa_jefe
```

Analizando el modelo individual, obtendremos los valores estimados bo, .., b5 para cada variable explicativa. Así también un análisis general de los residuos.
```{r}

modeloCDMX <- lm(datos$ing_cor ~ edad_jefe + erogac_tot + gasto_mon + sexo_jefe + educa_jefe, datos) 
summary(modeloCDMX) 

```
Renombramos las variables del sexo 1: hombre y 2: mujer
```{r}
  datos$sexo_jefe <- factor(datos$sexo_jefe)
  levels(datos$sexo_jefe) <- c("Hombre","Mujer")
```


Graficas de las variables independientes elegidas vs ingreso
```{r}
#AGREGUEN MÁS O PÓNGANLAS MÁS BONITAS SI GUSTAN
ggplot(datos,aes(edad_jefe, ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Edad")
ggplot(datos,aes(erogac_tot, ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Erogaciones totales")
ggplot(datos,aes(gasto_mon, ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Gasto monetario")
ggplot(datos,aes(sexo_jefe, ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Sexo")
ggplot(datos,aes(as.factor(educa_jefe), ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Años escolarizados")

```
Por si les sirve para algún supuesto... se ve bonita jajaja
Correlación considerando edad, erogac_tot, gasto_mon y educa_jefe
```{r}
#Correlación entre variables
datos%>%
  select(edad_jefe, erogac_tot, gasto_mon, educa_jefe) %>%
  ggcorr(palette = "RdBu", label = TRUE)
```
Como $\rho_{erogac,gasto}$ = 0.7, decidimos quitar las erogaciones totales y la matriz de correlación queda como:
```{r}
#Correlación entre variables
datos%>%
  select(edad_jefe, gasto_mon, educa_jefe) %>%
  ggcorr(palette = "RdBu", label = TRUE)
```
Tras reducir el modelo por una variable; es decir, tras quitar las erogaciones totales, el modelo mejorado queda como
```{r}
  mejoraCDMX <- lm(datos$ing_cor ~ edad_jefe  + gasto_mon + sexo_jefe + educa_jefe, datos) 
  summary(mejoraCDMX) 
```



Gráfica de Residuos vs Y estimada
```{r}
install.packages("ggthemes")
library(ggthemes)
ggplot(modeloCDMX, aes(x = modeloCDMX$fitted.values ,y = modeloCDMX$residuals)) + 
  labs(x = 'Ingreso Estimado',y = 'Residuos Estandarizados', title = 'Ingreso Estimado vs. Residuos') +
  geom_point() +
  theme_economist()
```
Para supuesto esperanza cero del error y NORMALIDAD DE LOS ERRORES (creo que no se ven muy normales jajaj):
```{r}
media_error <- sum(modeloCDMX$residuals)

S <-sqrt((sum(modeloCDMX$residuals)^2)/(2169-6))
resi_est <- modeloCDMX$residuals/S

modeloCDMX %>% 
  ggplot(aes(x=resi_est)) + geom_histogram() + theme_economist_white()

modeloCDMX %>% 
  ggplot(aes(x=resi_est)) + geom_density() + theme_economist_white()
install.packages("normtest")
library(normtest)
jb.norm.test(modeloCDMX$residuals,nrepl=2000) #Use Jarque Bera porque ya incluye lo de asimetría y kurtosis
#Se rechaza la hipótesis nula de que se distribuyen normal
```
DATOS ATÍPICOS
```{r}
ggplot(modeloCDMX, aes(resi_est)) + 
  geom_boxplot() +
  theme_economist()
#Nueva columna con los errores estandarizados y para el ingreso estimado
datos = mutate(datos, resi_est)
ing_esti <- datos$ing_cor + modeloCDMX$residuals
datos = mutate(datos, ing_esti )
datos %>% arrange(resi_est)
   view(datos)
```





