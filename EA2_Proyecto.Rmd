---
title: "EA2_Proyecto"
output: html_document
---

```{r}
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
#install.packages("olsrr"), es para las regresiones
library(olsrr)
#install.packates("GGally"), extensión de ggplot
#install.packages("GGally")
library(GGally)
```

Lectura de la base de datos
```{r}
  datos <- read.csv("BaseDatosEA2.csv")
```

Número de renglones y nombre de las columnas 
```{r}
  nrow(datos) 
  names(datos)
```

Seleccionamos las columnas que queremos trabajar y filtrando CDMX para nuestro análisis
```{r}

 datos <- datos %>% 
  select(sexo_jefe,edad_jefe,educa_jefe,tot_integ,perc_ocupa, ubica_geo, est_socio, ing_cor,gasto_mon,otros_gas,ahorro,deposito,retiro_inv,pago_tarje, tabaco, erogac_tot, 
         deudas, vestido, transporte) %>% 
  filter(ubica_geo > 8999, ubica_geo < 10000)
#Otras erogaciones: suma de depositos, pago de deudas, tarjetas de crédito, préstamos a otros

#Creamos una nueva columna para la edad al cuadrado
datos = mutate(datos, edad_2=datos$edad_jefe^2)
  head(datos)
```

Algunas gráficas que podrían ser de utilidad para la elección de variables 
```{r}

#AGREGUEN MÁS O PÓNGANLAS MÁS BONITAS SI GUSTAN
ggplot(datos,aes(datos$educa_jefe, datos$ing_cor))+geom_point()
ggplot(datos,aes(datos$tot_integ, datos$ing_cor))+geom_point()
ggplot(datos,aes(datos$erogac_tot, datos$ing_cor))+geom_point()
ggplot(datos,aes(datos$tabaco, datos$ing_cor))+geom_point()
ggplot(datos,aes(datos$deudas, datos$ing_cor))+geom_point()
ggplot(datos,aes(datos$edad_2, datos$ing_cor))+geom_point()
ggplot(datos,aes(datos$est_socio, datos$ing_cor))+geom_point()



```

Optimizar la elección de variables para nuestro modelo de regresión lineal múltiple.

Buscamos estimar al ingreso de las viviendas en CDMX, ya no al ahorro por la manera en la que la definimos Ahorro = Ingresos - Gastos, si ocupamos cualquier otra variable que no sea ingreso y gasto obtenemos una R^2 máxima del 20%

```{r}
#Esta era el modelo que teníamos del ahorro
#modeloAhorro <- lm(datos$ahorro ~ ing_cor + sexo_jefe + educa_jefe + tot_integ + perc_ocupa + tabaco + erogac_tot, data = datos)
#ols_step_best_subset(modeloAhorro)

#Otras erogaciones: suma de depositos, pago de deudas, tarjetas de crédito, préstamos a otros

#Regresión múltiple lineal entre todas las combinaciones posibles de 8 variables
modeloCDMX <- lm(datos$ing_cor ~ est_socio + edad_2 + perc_ocupa + erogac_tot + gasto_mon + sexo_jefe + educa_jefe + tot_integ, data = datos)

#Optimiza y muestra las mejores 8 regresiones por número de variables a tomar en cuenta
ols_step_best_subset(modeloCDMX)

#Tomamos la primera que alcanza una R^2 de 0.7 con 5 variables
# Ingreso = edad_2 + perc_ocupa + erogac_tot + gasto_mon + educa_jefe
```

Analizando el modelo individual, obtendremos los valores estimados bo, .., b5 para cada variable explicativa. Así también un análisis general de los residuos.
```{r}

modeloCDMX <- lm(datos$ing_cor ~ edad_2 + perc_ocupa + erogac_tot + gasto_mon + educa_jefe, data = datos)
summary(modeloCDMX)

```

Por si les sirve para algún supuesto... se ve bonita jajaja
```{r}
#Correlación entre variables
datos%>%
  select(edad_2, perc_ocupa, erogac_tot, gasto_mon, educa_jefe) %>%
  ggcorr(palette = "RdBu", label = TRUE)
```
Gráfica de Residuos vs Y estimada
```{r}
install.packages("ggthemes")
library(ggthemes)
ggplot(modeloCDMX, aes(x = modeloCDMX$fitted.values ,y = modeloCDMX$residuals)) + 
  labs(x = 'Ingreso Estimado',y = 'Residuos', title = 'Ingreso Estimado vs. Residuos') +
  geom_point() +
  theme_economist()
```
Para supuesto esperanza cero del error y normalidad de los errores (creo que no se ven muy normales jajaj):
```{r}
media_error <- sum(modeloCDMX$residuals)
resi_2 <- modeloCDMX$residuals/(sum(modeloCDMX$residuals)^2)/(2169-6)

modeloCDMX %>% 
  ggplot(aes(x=resi_2)) + geom_histogram() + theme_economist_white()

modeloCDMX %>% 
  ggplot(aes(x=resi_2)) + geom_density() + theme_economist_white()
install.packages("normtest")
library(normtest)
jb.norm.test(modeloCDMX$residuals,nrepl=2000) #Use Jarque Bera porque ya incluye lo de asimetría y kurtosis
#Se rechaza la hipótesis nula de que se distribuyen normal
```






