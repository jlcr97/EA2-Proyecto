---
title: "EA2_Proyecto"
output: html_document
---

```{r}
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
#install.packages("olsrr"), es para las regresiones
library(olsrr)
#install.packates("GGally"), extensión de ggplot
#install.packages("GGally")
library(GGally)
library(MASS)
library(lmtest)
library(orcutt)
library(HoRM)
library(car)
```

Lectura de la base de datos 
```{r}
  #datos <- read.csv("BaseDatosEA2.csv") 
  #Cambiamos la base porque nos marcaba error en la linea 43, esta base ya esta limpia, solo estan los datos de Alvaro Obregon y las variables que
  #pensamos utilizar en el modelo
  datos <- read.csv("BaseDatos2.csv")
```

Número de renglones y nombre de las columnas 
```{r}
  nrow(datos) 
  names(datos)
```

Como ya tenemos la base de los datos de Alvaro Obregon y las variables que pensamos utilizar en el modelo ya no haremos este Chunk

ESTO YA NO ----------------------------------------------------------------------------------------------------------------
Seleccionamos las columnas que queremos trabajar y filtrando Avaro Obregon para nuestro análisis
```{r}
 #datos <- datos %>%  #CAUSA ERROR
  #select(sexo_jefe,edad_jefe,educa_jefe,tot_integ,perc_ocupa, ubica_geo, est_socio, ing_cor,gasto_mon,otros_gas,ahorro,deposito,retiro_inv,pago_tarje, tabaco, erogac_tot, 
         #deudas, vestido, transporte) %>% 
  #filter(ubica_geo > 9009, ubica_geo < 9011) ##Alvaro Obregon es el 9010
#Otras erogaciones: suma de depositos, pago de deudas, tarjetas de crédito, préstamos a otros
   #nrow(datos)
   #head(datos)
#Creamos una nueva columna para la edad al cuadrado
#datos = mutate(datos, edad_2=datos$edad_jefe^2)
#  head(datos)
```
--------------------------------------------------------------------------------

Optimizar la elección de variables para nuestro modelo de regresión lineal múltiple.


```{r}
#Regresión múltiple lineal entre todas las combinaciones posibles de 8 variables
modeloCDMX <- lm(datos$ing_cor ~ est_socio + perc_ocupa + erogac_tot + gasto_mon + sexo_jefe + educa_jefe + tot_integ + edad_jefe, data = datos)
summary(modeloCDMX)

#Optimiza y muestra las mejores 8 regresiones por número de variables a tomar en cuenta
ols_step_best_subset(modeloCDMX)

```

Analizando el modelo individual, obtendremos los valores estimados bo, .., b6 para cada variable explicativa. Así también un análisis general de los residuos.
```{r}

modeloCDMX <- lm(datos$ing_cor ~ edad_jefe + erogac_tot + gasto_mon + sexo_jefe + educa_jefe + est_socio, datos)
summary(modeloCDMX) 
```
Notemos que por el **p-value** y el **estadístico F**, se rechaza la hipótesis de que $\beta_0 \neq 0$, por lo que sí tenemos ordenada al origen.
También veamos que con las **pruebas t** rechazamos las variables de sexo del jefe del hogar y el estrato socioeconómico del mismo. Por lo tanto, solo vamos a considerar a $Y = \beta_0 + \beta_1 X_{edad} + \beta_2 X_{erogac} + \beta_4 X_{gasto} + \beta_5 X_{añosEsc}$


Renombramos las variables del sexo 1: hombre y 0: mujer
```{r}
  datos$sexo_jefe <- factor(datos$sexo_jefe)
  levels(datos$sexo_jefe) <- c("Hombre","Mujer")
```


Graficas de las variables independientes elegidas vs ingreso
```{r}
#AGREGUEN MÁS O PÓNGANLAS MÁS BONITAS SI GUSTAN
ggplot(datos,aes(edad_jefe, ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Edad")
ggplot(datos,aes(erogac_tot, ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Erogaciones totales")
ggplot(datos,aes(gasto_mon, ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Gasto monetario")
ggplot(datos,aes(sexo_jefe, ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Sexo")
ggplot(datos,aes(as.factor(educa_jefe), ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Años escolarizados")
ggplot(datos,aes(as.factor(est_socio), ing_cor))+geom_point() +labs(y= "Ingreso corriente", x = "Estrato socioeconómico")
```


Tras reducir el modelo por dos variable; es decir, tras quitar el estrato socioeconómico y el sexo, el modelo mejorado queda como $Y = \beta_0 + \beta_1 X_{edad} + \beta_2 X_{erogac} + \beta_4 X_{gasto} + \beta_5 X_{añosEsc}$
```{r}
  mejoraCDMX <- lm(datos$ing_cor ~ edad_jefe  +erogac_tot + gasto_mon  + educa_jefe, datos) 
  summary(mejoraCDMX) 
```

Analizamos la tendencia de autocorrelación gráficamente:
```{r}
  plot(mejoraCDMX)
```


Ahora llevamos a cabo la prueba Durbin-Watson
```{r}
  dwtest(mejoraCDMX)
```

Como efectivamente hay autocorrelación, llevamos a cabo el método de Cochrane-Orcutt para agregar un AR(1) en el modelo
```{r}
  #install.packages("orcutt")
  #library(orcutt)
  mCorregido <- cochrane.orcutt(mejoraCDMX)
  summary(mCorregido)
  mCorregido
```

Esto es para la **autocorrelación**
Notemos que con el nuevo modelo, ya no hay autocorrelación
```{r}
  dwtest(mCorregido)
```

Utilizaremos el método de Hildreth Lu
```{r} 
  HL <- hildreth.lu(y=datos$ing_cor,x=c(datos$edad_jefe, datos$educa_jefe, datos$gasto_mon, datos$erogac_tot), rho=.215)
  HL

```



Gráfica de Residuos vs Y estimada
```{r}
install.packages("ggthemes")
library(ggthemes)
ggplot(modeloCDMX, aes(x = modeloCDMX$fitted.values ,y = modeloCDMX$residuals)) + 
  labs(x = 'Ingreso Estimado',y = 'Residuos Estandarizados', title = 'Ingreso Estimado vs. Residuos') +
  geom_point() +
  theme_economist()
```


Para supuesto esperanza cero del error y NORMALIDAD DE LOS ERRORES (creo que no se ven muy normales jajaj):
```{r}
media_error <- sum(modeloCDMX$residuals)

S <-sqrt((sum(modeloCDMX$residuals)^2)/(2169-6))
resi_est <- modeloCDMX$residuals/S

modeloCDMX %>% 
  ggplot(aes(x=resi_est)) + geom_histogram() + theme_economist_white()

modeloCDMX %>% 
  ggplot(aes(x=resi_est)) + geom_density() + theme_economist_white()
install.packages("normtest")
library(normtest)
jb.norm.test(modeloCDMX$residuals,nrepl=2000) #Use Jarque Bera porque ya incluye lo de asimetría y kurtosis
#Se rechaza la hipótesis nula de que se distribuyen normal
```


DATOS ATÍPICOS
```{r}
ggplot(modeloCDMX, aes(resi_est)) + 
  geom_boxplot() +
  theme_economist()
#Nueva columna con los errores estandarizados y para el ingreso estimado
datos = mutate(datos, resi_est)
ing_esti <- datos$ing_cor + modeloCDMX$residuals
datos = mutate(datos, ing_esti )
datos %>% arrange(resi_est)
   view(datos)
```





